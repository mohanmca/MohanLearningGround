# When to use rules engine
* Business logic which you think is getting cluttered with multiple if conditions due to complexity
* Business logic requires special treatment like version control, development, debugging, sme-managed, decision-table-driven
* Domain business logic complexity would be growing exponentially
* Business logic would be keep changing (seasonl, competitor driven, market-driven)
* Deleate business rools using single line code 'ruleEngine.applyRules(product);'
* Corporate decidedto put a rule admin console in the hands of non-technical people.

# Drools
* Latest version = 7.17.0 as on 20-Feb-2019
* no-loop: avoid the re-activation of a rule caused by the RHS of that SAME rule.
* lock-on-active: avoid the re-activation of a rule NO MATTER what the cause is.


# DSL - DRL
## DSL (Or dictionary)
* The Dictionary file (or DSL) is a text file (with a .dsl extension) that contains DSL entries.
* Dictionary file that defines the  translation of business concepts and DRL is simply called DSL in Drools
* DSL used only during compile time to create rules.
* DSL Contains the transformation
* Replaced everything using regex, focus on what is left after '='


## DSLR - DSL Rules
* File containing rules using business concepts is called DSLR
* SME is in charge of the creation and maintenance of the business rules (DSLR).

```DSL
# Simple DSL example file
[keyword]avoid looping=no-loop true
[when]There is a Customer=$c:Customer()
[when]- with age between {low:\d*} and {high:\d*}=age >= {low}, age <= {high}
[when]- who is older than {low:\d*}=age > {low}
[when]- without a Category set=category == Customer.Category.NA
[then]Set Customer Category to {category:\w*}=modify($c)\{ setCategory(Customer.Category.{category}) \};
```

```DSLR
rule "Categorize Customers between 22 and 30"
avoid looping
when
    There is a Customer
        - with age between 22 and 30
        - without a Category set
then
    Set Customer Category to BRONZE
end
```
## Compiled using above two DSL + DSLR = DRL
```DRL
rule "Categorize Customers between 22 and 30"
no-loop true
when
    $c: Customer( age >= 22, age <= 30, category == Customer.Category.NA)
then
    modify($c){ setCategory(Customer.Category.BRONZE) }
end
```

# DSL - Decision Tables

## Decision Table
* Depends on org.drools:drools-decisiontables
* Rules using same structure could be used with decision table
* Defined in XLS, or CSV
  * Only the first worksheet of an XLS file will be scanned for rule definitions.
* Decision tables structure - Strict structure needs to be maintained
* Keywords: 
  * RuleSet, RuleTable, CONDITION and ACTION
  * Sequential, EscapeQuotes
  * Variables, Functions
  * Queries, Declare
* RuleSet
  * Row indicates the begining of the rules
  * Column indicates other subsequence keyword column
  * "RuleSet <com.blah.blah.package>" default is  rule_table
  * Attributes in the RuleSet section will affect the entire package where the rules are defined.
  * This may include rules defined in other assets outside the decision table where they are defined.
* RuleTable
  * NAME
  * DESCRIPTION
  * CONDITION
  * ACTION
  * METADATA  

* CONDITION
  * Left-hand-side of the rule
  * $param - can be used to specify a comma separated values further down in the column
  * $1, $2, and so on, can be used to access each individual value
  * forall(delimiter){snippet}
* ACTION
  * The value of the cell in the next row is optional and, if present, it represents an object reference, a global variable
  * When a condition is only composed of a binary operator (such as ==, >, <, and so on), the use of $param is optional.
    *  Drools will understand that the interpolation value has to be placed at the end of the condition.
* Debugging decision table
  * Pay attention the log of the compilation
  * Message [id=3, level=ERROR, path=chapter07/dtable-simple/customer-classification-simple.xls, line=24, column=0 text=[ERR 102] Line 24:29 mismatched input '=' in rule "Simple Customer Categorization_13"],
  * Dump the DRL compiled into console/file for debugging
    * 
    ```java
    import org.drools.decisiontable.DecisionTableProviderImpl;
    InputStream dtableIS = //get the input stream to the decision table file
    DecisionTableProviderImpl dtp = new DecisionTableProviderImpl();
    String drl = dtp.loadFromInputStream(dtableIS, null);
    ```
  * The line and column numbers in the error messages can be traced to the DRL generated by the DecisionTableProviderImpl class.
*  Decision tables are not ideal for every situation: one of the biggest limitations is that rules we can model using decision tables must have the same structure.

## Drolls language LHS
```DRL
    /* find map */
    Student($markMap : markMaap)
    eval($markMap["Maths"] > 90)
    /* find map and check condition */
    $student: Student($marks : markMap, $marks.get("Maths") > 90)
    /* find map and check key presence and check condition */
    $student: Student($marks : markMap, $marks.containsKey("Maths"), $marks.get("Maths") > 90)
    Cheese( type == "stilton" && price < 10, age == "mature" )
    /* alernative way to access map */
    $account : Account( hm[ "A" ] == "B" )
    /* Access map inside List<HashMap> */
    $map : Map(this["issue"] != "") from $rAlerts.reservationMap
```
### Handle list of hasmap
```#DRL
rule "Validate test"
when
    SomeClass($tMap : outHash)                       
    e: Map.Entry(k:key, v:value) from $tMap.entrySet()
    DateSet( tt: trainingType == "NEW" ) from v 
then
    System.out.println(e.getKey() + "-" + tt);
end
```



## Reference
* [When to use rules engine](https://stackoverflow.com/questions/2167358/pros-and-cons-of-java-rules-engines)
* [drools-dsl](https://github.com/integrallis/drools-dsl/tree/master/src/main/resources/rules)
* [DSLR](https://training-course-material.com/training/Filip_Drools_-_DSL)
* [Decision Tables](https://docs.jboss.org/drools/release/6.5.0.Final/drools-docs/html/ch06.html#d0e5713)

